name: Sync to HF Spaces (Final Fix)
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install huggingface_hub (fixed version)
        # 指定稳定版本，避免参数兼容问题
        run: pip install huggingface_hub==0.23.0

      - name: Upload files to HF Spaces (No Git!)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python - <<EOF
          from huggingface_hub import HfApi, upload_file
          import os

          # 初始化 HF API
          api = HfApi(token=os.environ["HF_TOKEN"])
          space_id = "iyougame/newdemo"

          # 遍历当前目录所有文件，排除无关目录
          for root, dirs, files in os.walk("."):
              if ".git" in root or ".github" in root or "hf_sync_temp" in root:
                  continue
              for file in files:
                  file_path = os.path.join(root, file)
                  # 修复：移除 overwrite，新版用 force_upload
                  api.upload_file(
                      path_or_fileobj=file_path,
                      path_in_repo=file_path.lstrip("./"),
                      repo_id=space_id,
                      repo_type="space",
                      force_upload=True  # 替代 overwrite，强制覆盖
                  )

          # 重启 Spaces
          api.restart_space(repo_id=space_id)
          print("✅ 所有文件上传完成，Spaces 已重启！")
          EOF
