name: Sync to HF Spaces (Final Working Version)
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: pip install requests

      - name: Sync Files to HF Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: iyougame/newdemo
        run: |
          # 清空旧的临时目录（避免残留）
          rm -rf hf_sync_temp || true
          mkdir -p hf_sync_temp
          
          # 直接克隆 HF Spaces 仓库（避免分支不匹配）
          git clone --depth=1 https://${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE_ID} hf_sync_temp
          
          # 进入克隆的仓库，清空所有文件（保留 .git 目录）
          cd hf_sync_temp
          rm -rf ./* || true
          
          # 复制 GitHub 代码到 HF 仓库目录（排除无关文件）
          rsync -av --exclude='.git/' --exclude='.github/' --exclude='hf_sync_temp/' ../* ./
          
          # 配置 Git 身份
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 提交并推送（强制覆盖）
          git add .
          git commit -m "Sync from GitHub: ${{ github.sha }}" || echo "No changes to commit"
          git push origin main --force
          
          # 重启 Spaces
          curl -X POST -H "Authorization: Bearer ${HF_TOKEN}" https://huggingface.co/api/spaces/${HF_SPACE_ID}/restart
